---
title: "Project Modeling"
author: "Ethan Shen, Steven Herrera, Malavi Ravindran, Austin Jia"
date: "11/23/2019"
output: html_document
---

```{r, echo = FALSE, include = FALSE} 
# Installing packages
pkgTest <- function(x) {
  if (!require(x,character.only = TRUE)) {
    install.packages(x,dep=TRUE) 
  }
}
pkgs <- c("tidyverse", "ggplot2", "ggpubr", "cowplot", "reshape2", "caTools", "MASS", "psych")

for (pkg in pkgs) {
  pkgTest(pkg)
}
```

```{r}
library(tidyverse)
library(ggplot2)
library(ggpubr)
library(cowplot)
library(reshape2)
library(caTools) 
library(MASS)
require(foreign)
require(Hmisc)
require(reshape2)
library(e1071)
library(caret)
library(psych)
library(randomForest)
```

```{r message = FALSE}
school_df_final <- read_csv("school_df_final.csv")
school_df_final <- school_df_final %>%
  na.omit()
```

### Visualizations

```{r}
yes = c("#66c2a5",
        "#fc8d62",
        "#8da0cb",
        "#e78ac3")


ya = c(
  "#8dd3c7",
  "#ffffb3",
  "#bebada",
  "#fb8072"
)

heh = c(
  "#1f78b4",
  "#fdbf6f",
  "#33a02c",
  "#fb9a99"
)
avg.dem.dist <- school_df_final %>%
  group_by(region) %>%
  mutate(mean_percent_white = mean(percent_white, na.rm = TRUE),
         mean_percent_male = mean(percent_male, na.rm = TRUE),
         mean_percent_eds = mean(percent_eds, na.rm = TRUE),
         mean_percent_swd = mean(percent_swd, na.rm = TRUE)) %>%
  distinct(region, 
           mean_percent_white,
           mean_percent_male,
           mean_percent_eds,
           mean_percent_swd) %>%
  gather(variable, value, -region) 

ggplot(avg.dem.dist, aes(x = region, y = value * 100, fill = reorder(variable, -value))) + 
  geom_bar(stat = "identity", position = "dodge") + 
  scale_fill_manual(name = "Demographic Label", 
                    labels = c("White", "Male", "Economically Disadvantaged", "Students with Disabilities"),
                    values = heh#c("#a1dab4", "#41b6c4", "#225ea8", "#253494")
  ) + 
  #  scale_fill_discrete(name = "Demographic Label", labels = c("White", "Male", "EDS", "SWD")) + 
  
  labs(title = "Average Demographic Distribution by Region", 
       x = "Region", 
       y = "Percent") + 
  theme_minimal() + 
  rotate_x_text(angle = 50)
```

```{r}
#TRY BOX COX. SCREEn. 

col.pal = c("#8dd3c7",
            "#ffffb3",
            "#bebada",
            "#fb8072",
            "#80b1d3",
            "#fdb462",
            "#b3de69",
            "#fccde5")


col.pal.2 = c('#66c2a5',
              '#fc8d62',
              '#8da0cb',
              '#e78ac3',
              '#a6d854',
              '#ffd92f',
              '#e5c494',
              '#b3b3b3')

ggplot(school_df_final, aes(x = growth_index_score, fill = region)) + 
  geom_histogram(binwidth = 0.9, show.legend = FALSE) + 
  facet_wrap(~region, nrow = 4) + 
  labs(title = "Histogram of Growth Index Score by Region", 
       x = "Growth Index Score", 
       y = "Count") +
  scale_fill_manual(values = col.pal.2) + 
  theme_bw() 
```


```{r}

ggplot(data = school_df_final %>% filter(!is.na(region)), aes(x = percent_white)) + 
  geom_histogram() + 
  facet_wrap(~region)
```

```{r}
avg <- school_df_final %>%
  group_by(region) %>%
  mutate(mean_percent_white = mean(percent_white, na.rm=TRUE),
         mean_percent_male = mean(percent_male, na.rm=TRUE),
         mean_percent_eds = mean(percent_eds, na.rm=TRUE),
         mean_percent_swd = mean(percent_swd, na.rm=TRUE))
avg %>%
  distinct(region, mean_percent_white) %>%
  filter(!is.na(region)) %>%
  spread(region, mean_percent_white)

ACT.info <- school_df_final %>%
  dplyr::select(percent_ACTEN_meeting, 
                percent_ACTMA_meeting,
                percent_ACTRD_meeting,
                percent_ACTSC_meeting,
                percent_ACTWR_meeting,
                percent_ACT_meeting)
cor.ACT <- cor(my_data2, use = "complete.obs")

get_upper_tri <- function(cormat){
  cormat[upper.tri(cormat)]<- NA
  return(cormat)
}
upper_tri <- get_upper_tri(cor.ACT)

melted_cormat <- melt(upper_tri, na.rm = TRUE)


ggplot(data = melted_cormat, aes(x=Var1, y=Var2, fill=value)) + 
  geom_tile(color = "white") + 
  labs(title = "Correlation Matrix of ACT Subcategories", 
       x = "",
       y = "") + 
  scale_fill_gradient2(low = "#edf8b1", mid = "#7fcdbb", high = "#2c7fb8", 
                       midpoint = (min(cor.ACT) + 1)/2, limit = c(min(cor.ACT),1), space = "Lab", 
                       name="Correlation") + 
  theme_minimal() +
  rotate_x_text(angle = 50) 
```

```{r}
numeric.cols <- school_df_final[ , purrr::map_lgl(school_df_final, is.numeric)]

pairs.panels(numeric.cols[c(ncol(numeric.cols), 1:4)],
                    smooth = FALSE,
                    pch = 1,
                    ellipses = FALSE,
                    hist.col = "#80b1d3")
pairs.panels(numeric.cols[c(ncol(numeric.cols), 5:8)],
                    smooth = FALSE,
                    pch = 1,
                    ellipses = FALSE,
                    hist.col = "#80b1d3")

pairs.panels(numeric.cols[c(ncol(numeric.cols), 9:11)],
                    smooth = FALSE,
                    pch = 1,
                    ellipses = FALSE,
                    hist.col = "#80b1d3")

pairs(numeric.cols[c(ncol(numeric.cols), 5:8)],
      lower.panel = NULL)

pairs(numeric.cols[c(ncol(numeric.cols), 9:11)],
      lower.panel = NULL)

```


### Modeling 

```{r}
#splitting data into training and testing

school_df_final$title_1 <- as.factor(school_df_final$title_1)
school_df_final$region <- as.factor(school_df_final$region)
school_df_final$growth_status <- as.factor(school_df_final$growth_status)

set.seed(123)   #  set seed to ensure you always have same random numbers generated
rows <- sample(nrow(school_df_final))
school_df_final <- school_df_final[rows, ]
sample = sample.split(school_df_final,SplitRatio = 0.75) # splits the data in the ratio mentioned in SplitRatio. After splitting marks these rows as logical TRUE and the the remaining are marked as logical FALSE
training =subset(school_df_final,sample ==TRUE) # creates a training dataset named train1 with rows which are marked as TRUE
testing=subset(school_df_final, sample==FALSE)
train = na.omit(training)
test = na.omit(testing)
```


#### Regression

```{r}
#testing for multicolinearity

#first, we will look for multicolinearity between the demographic variables (race, gender, eds, swd)

my_data1 <- training[, c(3,4,5,6)]
res1 <- cor(my_data1, use = "complete.obs")
res1
# my_data2 <- training[, c(8, 9, 10, 11, 12, 13)]
# res2 <- cor(my_data2, use = "complete.obs")
# res2
```

The first matrix does not show heavy multicolinearity. However, due to the heavity multicolonearity between all of the different types of ACT section performances (all above 0.8), we will just include the percent of students who met standards overall on the ACT (not broken down by subject). 

```{r}
#first we omit any remaining NA values from our data
training<-na.omit(training) 
training
```


##### Linear
```{r}
#linear model with selection- first, we are fitting a full model (except for those specific ACT variables we are cutting)
linear.fit1 <- lm(growth_index_score ~ percent_white + percent_male + percent_eds + percent_swd + title_1 + percent_ACT_meeting + missed_school_days + region, data = training)
summary(linear.fit1)

```

Our full model does not perform well (very low adjusted R squared). We will try performing stepwise selection on the model to see if we can improve performance.


```{r}
#linear model with stepwise selection
linear.fit2 <- stepAIC(linear.fit1, direction = "both", trace = FALSE)
summary(linear.fit2)
```

It is clear that race, region, and ACT performance are strong indicators of performance. Are any interactions significant?

```{r}
#different linear model with interactions
linear.fit3 <- lm(growth_index_score ~ percent_white + percent_ACT_meeting  + region + percent_white*percent_ACT_meeting +  percent_white*region
                  + region*percent_ACT_meeting, data = training)

linear.fit4 <- lm(growth_index_score ~ percent_white + percent_ACT_meeting  + region + percent_white*percent_ACT_meeting +  percent_white*region, data = training)

linear.fit5 <- lm(growth_index_score ~ percent_white + percent_ACT_meeting  + region + percent_white*region
                  + region*percent_ACT_meeting, data = training)

linear.fit6 <- lm(growth_index_score ~ percent_white + percent_ACT_meeting  + region + percent_white*percent_ACT_meeting + region*percent_ACT_meeting, data = training)

linear.fit7 <- lm(growth_index_score ~ percent_white + percent_ACT_meeting  + region +  percent_white*percent_ACT_meeting, data = training)

linear.fit8 <- lm(growth_index_score ~ percent_white + percent_ACT_meeting  + region +  percent_white*region, data = training)

linear.fit9 <- lm(growth_index_score ~ percent_white + percent_ACT_meeting  + region +  region*percent_ACT_meeting, data = training)

summary(linear.fit2)$adj.r.squared 
summary(linear.fit3)$adj.r.squared 
summary(linear.fit4)$adj.r.squared 
summary(linear.fit5)$adj.r.squared 
summary(linear.fit6)$adj.r.squared 
summary(linear.fit7)$adj.r.squared 
summary(linear.fit8)$adj.r.squared 
summary(linear.fit9)$adj.r.squared 
```

```{r}
#Interactions have slightly improved the the adjusted R squared. We will choose the following model as our final linear model based on adjusted R squared value.
#But now, calculating MSE for the various models, we see that the model without interactions has the lowest test MSE

actual <- testing$growth_index_score
pred <- pred <- predict.lm(linear.fit2, testing)

#mse function
MSE <- function(predictions, actual) {
  mean_squared_error = 0
  for (i in 1:length(predictions)){
    predicted_value = predictions[i]
    actual_value = actual[i]
    diff = (predicted_value - actual_value)
    squared_diff = diff^2
   d_error = mean_squared_error + squared_diff
  }
  mse = mean_squared_error/length(predictions)
  return(mse)
}
MSE(actual, pred)

linear.fit.final <- lm(growth_index_score ~ percent_white + percent_ACT_meeting  + region + percent_white*region
                       + region*percent_ACT_meeting, data = training)
summary(linear.fit.final)

```


We will try fitting GAMs.


Now we will move to classif mean_squareication.


```{r}
ord.logistic <- polr(growth_status ~ percent_white + percent_ACT_meeting + 
    region + percent_white*percent_ACT_meeting, data = training, Hess=TRUE)
summary(ord.logistic)
```

```{r}
p <- predict(ord.logistic, testing)
```


```{r}
cfm <- confusionMatrix(p, testing$growth_status)
cfm
mean(p != testing$growth_status)
```






summary(final_school_data$growth_index_score)

##### Random Forest

```{r}
rf.reg <- randomForest(
  growth_index_score ~ . -school_code - school_name - percent_ACTWR_meeting - percent_ACTSC_meeting - percent_ACTRD_meeting - percent_ACTMA_meeting - percent_ACTEN_meeting - growth_status,
  data=train, ntree = 10000)
summary(rf.reg)
rf.reg
model.diagnostics(rf.reg)
varImpPlot(rf.reg)
``` 


### Classification 

##### Random Forest

```{r}
rf.class <- randomForest(growth_status ~ . -school_code - school_name - percent_ACTWR_meeting - percent_ACTSC_meeting - percent_ACTRD_meeting - percent_ACTMA_meeting - percent_ACTEN_meeting - growth_index_score, data=train, ntree = 1000)

pred = predict(rf.class, newdata=test)
cm = table(test$growth_status, pred)
cm
pred

mean(pred != test[,16])

varImpPlot(rf.class)
```
