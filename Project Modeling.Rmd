---
title: "Project Modeling"
author: "Ethan Shen, Steven Herrera, Malavi Ravindran, Austin Jia"
date: "11/23/2019"
output: html_document
---

```{r, echo = FALSE, include = FALSE}
# Installing packages
pkgTest <- function(x) {
  if (!require(x,character.only = TRUE)) {
    install.packages(x,dep=TRUE)
  }
}
pkgs <- c("tidyverse", "ggplot2", "ggpubr", "caTools", "MASS")

for (pkg in pkgs) {
  pkgTest(pkg)
}
```

```{r}
library(tidyverse)
library(ggplot2)
library(ggpubr)
library(caTools) 
library(MASS)
```

```{r}
school_df_final <- read_csv("school_df_final.csv")
school_df_final <- school_df_final %>%
  na.omit()
```

### Visualizations

```{r}
school_df_final %>%
  group_by(region) %>%
  mutate(mean_percent_white = mean(percent_white, na.rm = TRUE),
         mean_percent_male = mean(percent_male, na.rm = TRUE),
         mean_percent_eds = mean(percent_eds, na.rm = TRUE),
         mean_percent_swd = mean(percent_swd, na.rm = TRUE)) %>%
  distinct(region, 
           mean_percent_white,
           mean_percent_male,
           mean_percent_eds,
           mean_percent_swd) %>%
  gather(variable, value, -region) %>%
  ggplot(aes(x = region, y = value * 100, fill = reorder(variable, -value))) + 
  geom_bar(stat = "identity", position = "dodge") + 
  scale_fill_discrete(name = "Demographic Label", labels = c("White", "Male", "EDS", "SWD")) + 
  labs(title = "Average Demographic Distribution by Region", 
       x = "Region", 
       y = "Percent") + 
  theme_minimal() + 
  rotate_x_text(angle = 50)
```

```{r}
ggplot(school_df_final, aes(x = growth_index_score, fill = region)) + 
  geom_histogram(binwidth = 0.9, show.legend = FALSE) + 
  facet_wrap(~region, nrow = 4) + 
  labs(title = "Histogram of Growth Index Score by Region", 
       x = "Growth Index Score", 
       y = "Count") +
  theme_minimal() 
```


### Modeling 

```{r}
#splitting data into training and testing

set.seed(123)   #  set seed to ensure you always have same random numbers generated
rows <- sample(nrow(school_df_final))
school_df_final <- school_df_final[rows, ]
sample = sample.split(school_df_final,SplitRatio = 0.75) # splits the data in the ratio mentioned in SplitRatio. After splitting marks these rows as logical TRUE and the the remaining are marked as logical FALSE
training =subset(school_df_final,sample ==TRUE) # creates a training dataset named train1 with rows which are marked as TRUE
testing=subset(school_df_final, sample==FALSE)
```


```{r}
#testing for multicolinearity

#first, we will look for multicolinearity between the demographic variables (race, gender, eds, swd)

my_data1 <- training[, c(3,4,5,6)]
res1 <- cor(my_data1, use = "complete.obs")
res1
my_data2 <- training[, c(8, 9, 10, 11, 12, 13)]
res2 <- cor(my_data2, use = "complete.obs")
res2
```

The first matrix does not show heavy multicolinearity. However, due to the heavity multicolonearity between all of the different types of ACT section performances (all above 0.8), we will just include the percent of students who met standards overall on the ACT (not broken down by subject). 

```{r}
#first we omit any remaining NA values from our data
training<-na.omit(training) 
```



```{r}
#linear model with selection- first, we are fitting a full model (except for those specific ACT variables we are cutting)
linear.fit1 <- lm(growth_index_score ~ percent_white + percent_male + percent_eds + percent_swd + title_1 + percent_ACT_meeting + missed_school_days + region, data = training)
summary(linear.fit1)

```

Our full model does not perform well (very low adjusted R squared). We will try performing stepwise selection on the model to see if we can improve performance.


```{r}
#linear model with stepwise selection
linear.fit2 <- stepAIC(linear.fit1, direction = "both", trace = FALSE)
summary(linear.fit2)
```

It is clear that race, region, and ACT performance are strong indicators of performance. Are any interactions significant?

```{r}
#different linear model with interactions
linear.fit3 <- lm(growth_index_score ~ percent_white + percent_ACT_meeting  + region + percent_white*percent_ACT_meeting +  percent_white*region
                   + region*percent_ACT_meeting, data = training)

linear.fit4 <- lm(growth_index_score ~ percent_white + percent_ACT_meeting  + region + percent_white*percent_ACT_meeting +  percent_white*region, data = training)

linear.fit5 <- lm(growth_index_score ~ percent_white + percent_ACT_meeting  + region + percent_white*region
                   + region*percent_ACT_meeting, data = training)

linear.fit6 <- lm(growth_index_score ~ percent_white + percent_ACT_meeting  + region + percent_white*percent_ACT_meeting + region*percent_ACT_meeting, data = training)

linear.fit7 <- lm(growth_index_score ~ percent_white + percent_ACT_meeting  + region +  percent_white*percent_ACT_meeting, data = training)

linear.fit8 <- lm(growth_index_score ~ percent_white + percent_ACT_meeting  + region +  percent_white*region, data = training)

linear.fit9 <- lm(growth_index_score ~ percent_white + percent_ACT_meeting  + region +  region*percent_ACT_meeting, data = training)

summary(linear.fit2)$adj.r.squared 
summary(linear.fit3)$adj.r.squared 
summary(linear.fit4)$adj.r.squared 
summary(linear.fit5)$adj.r.squared 
summary(linear.fit6)$adj.r.squared 
summary(linear.fit7)$adj.r.squared 
summary(linear.fit8)$adj.r.squared 
summary(linear.fit9)$adj.r.squared 
```

```{r}
#Interactions have slightly improved the the adjusted R squared. We will choose the following model as our final linear model based on adjusted R squared value.

linear.fit.final <- lm(growth_index_score ~ percent_white + percent_ACT_meeting  + region + percent_white*region
                   + region*percent_ACT_meeting, data = training)
summary(linear.fit.final)
```


We will try fitting GAMs.

```{r}
#LATER
```

Now we will move to classification.


